<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foom.ist - When Silicon Surpasses Human Brainpower</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Watch in real-time as global chip production races to exceed the cumulative processing power of all human brains. An interactive visualization of the coming intelligence explosion.">
    <meta name="keywords" content="AI, artificial intelligence, singularity, MIPS, FLOPS, Moore's Law, brain computing, chip production, foom, intelligence explosion">
    <meta name="author" content="foom.ist">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://foom.ist/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://foom.ist/">
    <meta property="og:title" content="Foom.ist - When Silicon Surpasses Human Brainpower">
    <meta property="og:description" content="Watch in real-time as global chip production races to exceed the cumulative processing power of all human brains.">
    <meta property="og:image" content="https://foom.ist/og.jpg">
    <meta property="og:image:type" content="image/jpeg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Visualization showing chip FLOPS vs human brain processing power over time">
    <meta property="og:site_name" content="Foom.ist">
    <meta property="og:locale" content="en_US">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:domain" content="foom.ist">
    <meta name="twitter:url" content="https://foom.ist/">
    <meta name="twitter:title" content="Foom.ist - When Silicon Surpasses Human Brainpower">
    <meta name="twitter:description" content="Watch in real-time as global chip production races to exceed the cumulative processing power of all human brains.">
    <meta name="twitter:image" content="https://foom.ist/og.jpg">
    <meta name="twitter:image:alt" content="Visualization showing chip FLOPS vs human brain processing power over time">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§ </text></svg>">

    <!-- Theme Color -->
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Foom.ist",
        "description": "Interactive visualization of when global chip production will exceed human brain processing power",
        "url": "https://foom.ist",
        "applicationCategory": "Visualization",
        "operatingSystem": "Web Browser",
        "author": {
            "@type": "Organization",
            "name": "Foom.ist"
        }
    }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a2e;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent-human: #ff6b6b;
            --accent-chip: #4ecdc4;
            --accent-crossover: #ffd93d;
            --border-color: #2a2a3e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-human), var(--accent-chip));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .header-cta {
            margin-top: 1.5rem;
        }

        .cta-button {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent-chip), var(--accent-human));
            color: var(--bg-primary);
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }

        .share-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .share-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.8rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.75rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .share-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .share-btn.twitter:hover { border-color: #1da1f2; color: #1da1f2; }
        .share-btn.facebook:hover { border-color: #4267b2; color: #4267b2; }
        .share-btn.linkedin:hover { border-color: #0077b5; color: #0077b5; }
        .share-btn.copy:hover { border-color: var(--accent-chip); color: var(--accent-chip); }

        .share-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .counters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .counter-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .counter-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .counter-card.human::before {
            background: var(--accent-human);
        }

        .counter-card.chip::before {
            background: var(--accent-chip);
        }

        .counter-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .counter-value {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            font-weight: bold;
            font-family: 'SF Mono', monospace;
            margin-bottom: 0.5rem;
        }

        .counter-card.human .counter-value {
            color: var(--accent-human);
        }

        .counter-card.chip .counter-value {
            color: var(--accent-chip);
        }

        .counter-rate {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .crossover-banner {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            border: 2px solid var(--accent-crossover);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .crossover-title {
            color: var(--accent-crossover);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .crossover-date {
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: bold;
            color: var(--text-primary);
        }

        .crossover-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .controls {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .controls h2 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .control-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: var(--border-color);
        }

        .control-btn.active {
            background: var(--accent-chip);
            color: var(--bg-primary);
            border-color: var(--accent-chip);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-chip);
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-value {
            min-width: 60px;
            text-align: right;
            font-size: 0.85rem;
            color: var(--accent-chip);
        }

        .reset-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.7rem;
            margin-left: 0.5rem;
        }

        .reset-btn:hover {
            background: var(--accent-human);
            border-color: var(--accent-human);
            color: var(--bg-primary);
        }

        .data-status {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .data-status.live {
            border-left: 3px solid var(--accent-chip);
        }

        .data-status.cached {
            border-left: 3px solid var(--accent-crossover);
        }

        /* Suggestion Form Styles */
        .suggest-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .suggest-section h2 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .suggest-intro {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .suggest-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .form-group label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-chip);
        }

        .form-group input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .form-hint {
            font-size: 0.7rem;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .submit-btn {
            background: var(--accent-chip);
            border: none;
            color: var(--bg-primary);
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.2s;
            align-self: flex-start;
        }

        .submit-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .form-status {
            font-size: 0.85rem;
            padding: 0.5rem;
            border-radius: 4px;
            display: none;
        }

        .form-status.success {
            display: block;
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid var(--accent-chip);
            color: var(--accent-chip);
        }

        .form-status.error {
            display: block;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--accent-human);
            color: var(--accent-human);
        }

        .suggest-note {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 1rem;
            opacity: 0.8;
        }

        .suggest-note a {
            color: var(--accent-chip);
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .sources {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .sources h2 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .source-section {
            margin-bottom: 1.5rem;
        }

        .source-section:last-child {
            margin-bottom: 0;
        }

        .source-title {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .source-list {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .source-list a {
            color: var(--accent-chip);
            text-decoration: none;
        }

        .source-list a:hover {
            text-decoration: underline;
        }

        .assumption-box {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .assumption-box code {
            color: var(--accent-crossover);
            background: var(--bg-primary);
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
        }

        footer {
            text-align: center;
            padding: 2rem 0;
            color: var(--text-secondary);
            font-size: 0.75rem;
            border-top: 1px solid var(--border-color);
            margin-top: 2rem;
        }

        footer a {
            color: var(--accent-chip);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Definitions Panel */
        .definitions-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .definitions-panel summary {
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .definitions-panel summary::-webkit-details-marker {
            display: none;
        }

        .definitions-panel[open] summary {
            border-bottom: 1px solid var(--border-color);
        }

        .definitions-content {
            padding: 1rem 1.5rem;
        }

        .def-item {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .def-item:last-child {
            border-bottom: none;
        }

        .def-term {
            font-weight: bold;
            color: var(--accent-crossover);
            font-size: 0.9rem;
        }

        .def-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .def-desc em {
            color: var(--text-primary);
            font-style: italic;
        }

        /* Contribute + Info Panels */
        .contribute-box {
            background: linear-gradient(135deg, rgba(255, 217, 61, 0.08), rgba(78, 205, 196, 0.06));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin: 1.25rem 0 1.5rem 0;
        }

        .contribute-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .contribute-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .contribute-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .contribute-link {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            text-decoration: none;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.45rem 0.75rem;
            border-radius: 8px;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .contribute-link:hover {
            border-color: var(--accent-chip);
            color: var(--accent-chip);
        }

        .contribute-link.primary {
            background: var(--accent-chip);
            border-color: var(--accent-chip);
            color: var(--bg-primary);
            font-weight: 700;
        }

        .contribute-link.primary:hover {
            opacity: 0.9;
            color: var(--bg-primary);
        }

        .download-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin: 0.75rem 0 0.25rem 0;
            flex-wrap: wrap;
        }

        .download-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.85;
        }

        .privacy-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-top: 0.75rem;
        }

        .privacy-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-chip);
        }

        .privacy-hint {
            margin-top: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.85;
            line-height: 1.4;
        }

        /* Session Stats */
        .session-stats {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(255, 107, 107, 0.1));
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .session-stats span {
            font-weight: bold;
            font-family: 'SF Mono', monospace;
        }

        #session-brains {
            color: var(--accent-human);
        }

        #session-flops {
            color: var(--accent-chip);
        }

        /* Calculus Controls */
        .calculus-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .calc-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s;
            min-width: 60px;
        }

        .calc-btn:hover {
            border-color: var(--accent-chip);
            color: var(--accent-chip);
        }

        .calc-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .calc-level {
            font-size: 0.85rem;
            color: var(--accent-crossover);
            font-weight: bold;
            min-width: 140px;
            text-align: center;
        }

        .chart-hint {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-secondary);
            opacity: 0.7;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 600px) {
            .def-item {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }

            .calculus-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        .indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .indicator.human {
            background: var(--accent-human);
        }

        .indicator.chip {
            background: var(--accent-chip);
        }

        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }

            .chart-wrapper {
                height: 300px;
            }

            .control-btn {
                flex: 1;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>The Flippening is Coming</h1>
            <p class="subtitle">When cumulative chip FLOPS exceeds all human brainpower born since 1970</p>
            <div class="header-cta">
                <a href="#suggest-section" class="cta-button">Have better data? Help improve this</a>
            </div>
            <div class="share-buttons">
                <a href="https://x.com/intent/tweet?url=https://foom.ist&text=When%20will%20global%20chip%20production%20exceed%20human%20brainpower%3F%20Watch%20it%20happen%20in%20real-time." target="_blank" rel="noopener" class="share-btn twitter">
                    <svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    Share
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?u=https://foom.ist" target="_blank" rel="noopener" class="share-btn facebook">
                    <svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                    Share
                </a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://foom.ist" target="_blank" rel="noopener" class="share-btn linkedin">
                    <svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                    Share
                </a>
                <button onclick="copyLink()" class="share-btn copy">
                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                    <span id="copy-text">Copy Link</span>
                </button>
            </div>
        </header>

        <!-- Contribute -->
        <div class="contribute-box" id="contribute">
            <div class="contribute-title">Want to improve the data?</div>
            <div class="contribute-text">
                If you have a more accurate or more recent source for birth rates, brain FLOPS estimates, or chip production,
                you can submit it below. Suggestions open a GitHub issue automatically so other people can review and discuss.
            </div>
            <div class="contribute-actions">
                <a class="contribute-link primary" href="#suggest-section">Suggest better data</a>
                <a class="contribute-link" href="https://github.com/StefanSamne/foomist/issues?q=label%3Adata-suggestion" target="_blank" rel="noopener">Browse suggestions</a>
                <a class="contribute-link" href="https://github.com/StefanSamne/foomist/issues" target="_blank" rel="noopener">Open an issue</a>
                <a class="contribute-link" href="https://github.com/StefanSamne/foomist" target="_blank" rel="noopener">View source</a>
            </div>
        </div>

        <!-- Definitions Panel -->
        <details class="definitions-panel">
            <summary>What is this? â–¼</summary>
            <div class="definitions-content">
                <div class="def-item">
                    <span class="def-term">FOOM</span>
                    <span class="def-desc">The hypothetical moment of explosive, recursive AI self-improvement. Coined by Eliezer Yudkowsky. <em>When the curve goes vertical.</em></span>
                </div>
                <div class="def-item">
                    <span class="def-term">FLOPS</span>
                    <span class="def-desc">Floating Point Operations Per Second. For chips: measured compute. For brains: estimated at 10<sup>14</sup>â€“10<sup>18</sup> ops/s depending on model.</span>
                </div>
                <div class="def-item">
                    <span class="def-term">The Flippening</span>
                    <span class="def-desc">The crossover point where humanity's silicon creations exceed the raw computational substrate that created them.</span>
                </div>
            </div>
        </details>

        <!-- How it works -->
        <details class="definitions-panel">
            <summary>How the model works â–¼</summary>
            <div class="definitions-content">
                <div class="def-item">
                    <span class="def-term">Human curve</span>
                    <span class="def-desc">
                        For each year since 1970, estimate global births and multiply by a brain compute assumption
                        (10^14, 10^16, or 10^18 ops per second). Then sum across years to get a cumulative total.
                    </span>
                </div>
                <div class="def-item">
                    <span class="def-term">Chip curve</span>
                    <span class="def-desc">
                        For each year since 1970, estimate total FLOPS shipped that year (historical anchors with interpolation, then a growth rate),
                        then sum across years to get a cumulative total.
                    </span>
                </div>
                <div class="def-item">
                    <span class="def-term">Controls</span>
                    <span class="def-desc">
                        The buttons and slider change the assumptions and recompute the series immediately. The calculus toggle switches between cumulative,
                        rate (d/dt), and acceleration (dÂ²/dtÂ²) views.
                    </span>
                </div>
            </div>
        </details>

        <!-- Privacy -->
        <details class="definitions-panel">
            <summary>Privacy â–¼</summary>
            <div class="definitions-content">
                <div class="def-item">
                    <span class="def-term">What is collected</span>
                    <span class="def-desc">
                        This site logs basic, anonymous usage events (page load, button clicks, scroll depth) so I can learn what people find interesting.
                        The server also uses your IP address to estimate country and city for aggregate stats.
                    </span>
                </div>
                <div class="def-item">
                    <span class="def-term">Why</span>
                    <span class="def-desc">
                        Pure curiosity. No ads, no selling, and no cross-site tracking. Data expires after about 90 days.
                    </span>
                </div>
                <label class="privacy-toggle">
                    <input type="checkbox" id="analytics-optout">
                    Disable analytics on this device
                </label>
                <div class="privacy-hint">
                    If enabled, events will not be sent from this browser. You can also add <code>?noanalytics=1</code> to the URL.
                </div>
            </div>
        </details>

        <!-- Session Stats -->
        <div class="session-stats" id="session-stats">
            Since you opened this page: <span id="session-brains">0</span> brains born, <span id="session-flops">0</span> FLOPS capacity added
        </div>

        <div class="counters">
            <div class="counter-card human">
                <div class="counter-label">
                    <span class="indicator human pulse"></span>
                    Cumulative Human Brain ops/s (since 1970)
                </div>
                <div class="counter-value" id="human-mips">0</div>
                <div class="counter-rate" id="human-rate">Loading...</div>
            </div>
            <div class="counter-card chip">
                <div class="counter-label">
                    <span class="indicator chip pulse"></span>
                    Cumulative Chip FLOPS (since 1970)
                </div>
                <div class="counter-value" id="chip-mips">0</div>
                <div class="counter-rate" id="chip-rate">Loading...</div>
            </div>
        </div>

        <div class="crossover-banner">
            <div class="crossover-title">ESTIMATED CROSSOVER DATE</div>
            <div class="crossover-date" id="crossover-date">Calculating...</div>
            <div class="crossover-status" id="crossover-status"></div>
        </div>

        <div class="chart-container">
            <div class="calculus-controls">
                <button class="calc-btn" id="calc-up" title="Integrate (cumulative)">â†‘ âˆ«</button>
                <span class="calc-level" id="calc-level">âˆ« Cumulative</span>
                <button class="calc-btn" id="calc-down" title="Differentiate (rate of change)">â†“ d/dt</button>
                <button class="calc-btn" id="reset-zoom" title="Reset zoom">Reset Zoom</button>
            </div>
            <div class="chart-hint">Scroll to zoom â€¢ Drag to pan â€¢ Click legend to toggle series</div>
            <div class="download-controls">
                <span class="download-label">Download chart data:</span>
                <button class="calc-btn" id="download-csv" title="Download as CSV">CSV</button>
                <button class="calc-btn" id="download-json" title="Download as JSON">JSON</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="mips-chart"></canvas>
            </div>
        </div>

        <div class="controls">
            <h2>ADJUST ASSUMPTIONS</h2>

            <div class="control-group">
                <label class="control-label">Human Brain Processing Power Estimate</label>
                <div class="control-row">
                    <button class="control-btn" data-brain="conservative" title="Moravec's estimate based on retinal processing">
                        Conservative (10^14 ops/s)
                    </button>
                    <button class="control-btn active" data-brain="moderate" title="Mid-range estimate from synapse operations">
                        Moderate (10^16 ops/s)
                    </button>
                    <button class="control-btn" data-brain="aggressive" title="High estimate including all neural activity">
                        Aggressive (10^18 ops/s)
                    </button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Moore's Law Equivalent Growth Rate (% per year)</label>
                <div class="slider-container">
                    <input type="range" class="slider" id="moore-slider" min="20" max="60" value="35">
                    <span class="slider-value" id="moore-value">35%</span>
                    <button class="control-btn reset-btn" id="moore-reset" title="Reset to default (35%)">Reset</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Birth Rate Trend</label>
                <div class="control-row">
                    <button class="control-btn" data-birth="declining" title="UN projection: births declining ~0.5%/year">
                        Declining (-0.5%/yr)
                    </button>
                    <button class="control-btn active" data-birth="stable" title="Births remain stable at ~130M/year">
                        Stable (~130M/yr)
                    </button>
                    <button class="control-btn" data-birth="recovering" title="Hypothetical recovery scenario">
                        Recovering (+0.3%/yr)
                    </button>
                </div>
            </div>
        </div>

        <div class="sources">
            <h2>DATA SOURCES & ASSUMPTIONS</h2>

            <div class="source-section">
                <div class="source-title">Birth Rate Data</div>
                <div class="source-list">
                    <a href="https://ourworldindata.org/grapher/crude-birth-rate" target="_blank">Our World in Data - Birth Rate</a> |
                    <a href="https://www.un.org/development/desa/pd/" target="_blank">UN World Fertility Report 2024</a> |
                    <a href="https://statisticstimes.com/demographics/world-death-and-birth-rate.php" target="_blank">StatisticsTimes</a>
                </div>
                <div class="assumption-box">
                    Current: <code>~132.4M births/year</code> (2025) = <code>~4.2 births/second</code><br>
                    Historical peak: 146M births in 2012. Projected stable at 130-140M through 2050s.
                </div>
            </div>

            <div class="source-section">
                <div class="source-title">Human Brain Processing Estimates</div>
                <div class="source-list">
                    <a href="https://jetpress.org/volume1/moravec.htm" target="_blank">Moravec (1998)</a> |
                    <a href="https://aiimpacts.org/brain-performance-in-flops/" target="_blank">AI Impacts - Brain FLOPS</a> |
                    <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC7660359/" target="_blank">Sandberg & Bostrom</a>
                </div>
                <div class="assumption-box">
                    <strong>Conservative:</strong> <code>10^14 ops/s</code> - Moravec's retinal processing extrapolation<br>
                    <strong>Moderate:</strong> <code>10^16 ops/s</code> - Synapse count Ã— firing rate estimate<br>
                    <strong>Aggressive:</strong> <code>10^18 ops/s</code> - Full neural complexity estimate<br>
                    Note: MIPS â‰ˆ operations/second for comparison purposes. Actual brain computation is non-comparable.
                </div>
            </div>

            <div class="source-section">
                <div class="source-title">Chip Production Data</div>
                <div class="source-list">
                    <a href="https://investor.nvidia.com/financial-info/sec-filings/default.aspx" target="_blank">NVIDIA SEC 10-K Filings</a> |
                    <a href="https://epoch.ai/data/machine-learning-hardware" target="_blank">Epoch AI - ML Hardware Dataset</a> |
                    <a href="https://www.wsts.org/" target="_blank">WSTS - World Semiconductor Trade Statistics</a> |
                    <a href="https://www.semiconductors.org/data-resources/market-data/" target="_blank">SIA Market Data</a>
                </div>
                <div class="assumption-box">
                    <strong>2007:</strong> <code>2Ã—10^20 IPS</code> global capacity (Hilbert & Lopez, 2012)<br>
                    <strong>2021:</strong> <code>1.15T</code> semiconductor units shipped (WSTS)<br>
                    <strong>2023:</strong> NVIDIA shipped ~550K H100s @ 4 petaFLOPS = <code>2.2Ã—10^21</code> FLOPS<br>
                    <strong>2024:</strong> NVIDIA ~2M H100-equiv, $130B data center revenue (SEC 10-K)<br>
                    <strong>2025:</strong> Epoch AI projects 6.5-7M AI GPUs; installed base ~4M H100-equiv<br>
                    Hardware FLOPS/$ doubles every ~2.5 years (Epoch AI GPU dataset)
                </div>
            </div>

            <div class="source-section">
                <div class="source-title">Future Predictions (ðŸ”® in tooltips)</div>
                <div class="source-list">
                    <a href="https://ai-2027.com/" target="_blank">AI-2027.com</a> â€” Detailed scenario forecasting AGI/ASI timeline through 2027<br>
                    <a href="https://situational-awareness.ai/" target="_blank">Situational Awareness</a> â€” Leopold Aschenbrenner's analysis: "AGI by 2027 is strikingly plausible"
                </div>
                <div class="assumption-box">
                    <strong>AI-2027:</strong> Superhuman coder by March 2027, superhuman AI researcher by Sept 2027, potential superintelligence by Dec 2027.<br>
                    <strong>Situational Awareness:</strong> Intelligence explosion could compress "a decade of progress into â‰¤1 year." $100B+ compute clusters by end of decade.<br>
                    <em>Note: These are speculative forecasts, not established fact. Included for context on current AI timeline discourse.</em>
                </div>
            </div>

            <div class="source-section">
                <div class="source-title">Inspiration</div>
                <div class="source-list">
                    <blockquote style="font-style: italic; border-left: 3px solid var(--accent-crossover); padding-left: 1rem; margin: 0.5rem 0;">
                        "Welcome to the early twenty-first century, human.<br><br>
                        It's night in Milton Keynes, sunrise in Hong Kong. Moore's Law rolls inexorably on, dragging humanity toward the uncertain future. The planets of the solar system have a combined mass of approximately 2 Ã— 10<sup>27</sup> kilograms. Around the world, laboring women produce forty-five thousand babies a day, representing 10<sup>23</sup> MIPS of processing power. Also around the world, fab lines casually churn out thirty million microprocessors a day, representing 10<sup>23</sup> MIPS. In another ten months, most of the MIPS being added to the solar system will be machine-hosted for the first time. About ten years after that, the solar system's installed processing power will nudge the critical 1 MIPS per gram threshold â€“ one million instructions per second per gram of matter. After that, singularity â€“ a vanishing point beyond which extrapolating progress becomes meaningless. The time remaining before the intelligence spike is down to single-digit years ..."
                    </blockquote>
                    <div style="margin-top: 0.5rem;">â€” Charles Stross, <em>Accelerando</em> (2005)</div>
                </div>
            </div>
        </div>

        <!-- Suggestion Form -->
        <div class="suggest-section" id="suggest-section">
            <h2>SUGGEST BETTER DATA</h2>
            <p class="suggest-intro">Found a more accurate or recent source? Help improve this visualization.</p>

            <form id="suggest-form" class="suggest-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="data-type">Data Category</label>
                        <select id="data-type" name="dataType" required>
                            <option value="">Select...</option>
                            <option value="births">Birth Rate Data</option>
                            <option value="brain">Brain Processing Estimates</option>
                            <option value="chips">Chip Production Data</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="data-year">Year (if applicable)</label>
                        <input type="number" id="data-year" name="year" min="1970" max="2030" placeholder="e.g., 2024">
                    </div>
                </div>

                <div class="form-group">
                    <label for="source-url">Source URL</label>
                    <input type="url" id="source-url" name="sourceUrl" required
                           placeholder="https://example.gov/report.pdf"
                           pattern="https://.*">
                    <span class="form-hint">Must be HTTPS. Preferred: .gov, .edu, .org, arxiv.org, SEC.gov</span>
                </div>

                <div class="form-group">
                    <label for="data-value">Claimed Value</label>
                    <input type="text" id="data-value" name="value" required
                           placeholder="e.g., 135.2 million births in 2024"
                           maxlength="200">
                </div>

                <div class="form-group">
                    <label for="source-name">Source Name</label>
                    <input type="text" id="source-name" name="sourceName" required
                           placeholder="e.g., UN World Population Prospects 2024"
                           maxlength="100">
                </div>

                <button type="submit" class="submit-btn" id="submit-btn">
                    Submit Suggestion
                </button>
                <div id="form-status" class="form-status"></div>
            </form>

            <p class="suggest-note">
                Suggestions are reviewed by an AI system that verifies the source and updates the site automatically if valid.
                <a href="https://github.com/StefanSamne/foomist/issues" target="_blank">View pending suggestions</a>
            </p>
        </div>

        <footer>
            <p>Inspired by Charles Stross's <em>Accelerando</em> |
            <a href="https://github.com/StefanSamne/foomist" target="_blank">View Source</a> |
            Data updated January 2026</p>
            <p style="margin-top: 0.5rem;">
                Note: This is a thought experiment. Brain processing and chip MIPS are fundamentally different
                and not directly comparable. The crossover is symbolic, not literal.
            </p>
        </footer>
    </div>

    <script>
        // Register Chart.js annotation plugin
        const annotationPlugin = window['chartjs-plugin-annotation'];
        console.log('Annotation plugin loaded:', annotationPlugin);
        if (annotationPlugin) {
            Chart.register(annotationPlugin);
            console.log('Annotation plugin registered');
        } else {
            console.error('Annotation plugin NOT found!');
        }

        // ============================================
        // CONFIGURATION & CONSTANTS
        // ============================================

        const DEFAULTS = {
            mooresLawRate: 0.35  // 35% annual growth - can be reset to this
        };

        const CONFIG = {
            // Brain processing estimates (operations per second)
            brainEstimates: {
                conservative: 1e14,  // 10^14 ops/s - Moravec
                moderate: 1e16,      // 10^16 ops/s - Synapse-based
                aggressive: 1e18    // 10^18 ops/s - High estimate
            },

            // Birth rate scenarios (births per year, with annual change rate)
            birthScenarios: {
                declining: { base2025: 132.4e6, annualChange: -0.005 },
                stable: { base2025: 132.4e6, annualChange: 0 },
                recovering: { base2025: 132.4e6, annualChange: 0.003 }
            },

            // Historical birth data (millions per year)
            historicalBirths: {
                1970: 121, 1975: 124, 1980: 129, 1985: 137, 1990: 143,
                1995: 134, 2000: 130, 2005: 134, 2010: 140, 2012: 146,
                2015: 142, 2020: 140, 2025: 132
            },

            // Chip FLOPS history (estimated total FLOPS shipped that year)
            // Sources: Hilbert & Lopez (2012), Epoch AI, NVIDIA SEC 10-K, WSTS, SIA
            // Note: Using FLOPS as proxy for "operations" - more accurate than MIPS for modern chips
            historicalChipFLOPS: {
                1971: 1e3,           // Intel 4004: 0.09 MIPS, ~2,300 chips sold
                1975: 1e6,           // 8080 era, early hobbyist computers
                1980: 1e9,           // 8086/Z80, ~10M microprocessors
                1985: 1e11,          // 80286/386, PC boom begins
                1990: 1e13,          // 486 era, ~50M PCs sold/year
                1995: 5e14,          // Pentium era, ~100M PCs/year
                2000: 1e16,          // GHz race, ~150M PCs/year
                2005: 5e17,          // Multi-core, mobile begins
                2007: 2e20,          // Hilbert & Lopez measured: 2Ã—10^20 IPS global capacity
                2010: 1e21,          // Smartphone explosion, 1.5B chips/year
                2015: 5e21,          // Epoch AI: ~10^21-10^22 range
                2018: 1e22,          // 23.3B microprocessor units shipped (Statista)
                2020: 2e22,          // COVID chip demand surge
                2021: 4e22,          // 1.15T semiconductor units shipped (WSTS)
                2023: 8e22,          // NVIDIA: 550K H100s @ 4 petaFLOPS each = 2.2e21 just from H100
                2024: 2e23,          // NVIDIA: ~2M H100s + Blackwell ramp, total AI chips ~4M H100-equiv
                2025: 4e23           // Epoch AI projects 6.5-7M AI GPUs, plus consumer/mobile
            },

            startYear: 1970,
            endYear: 2070,
            baseYear: 2025,

            // Historical annotations for tooltips
            annotations: [
                // Birth/Human milestones
                { year: 1970, type: 'human', note: 'World population: 3.7B. Post-war baby boom winding down.' },
                { year: 1987, type: 'human', note: 'World population hits 5 billion (July 11). Peak annual birth rate approaching.' },
                { year: 1990, type: 'human', note: 'Birth rates peak at 143M/year. Soviet collapse begins demographic crisis in Eastern Europe.' },
                { year: 1999, type: 'human', note: 'World population reaches 6 billion. Birth rates declining as development spreads.' },
                { year: 2011, type: 'human', note: 'World population hits 7 billion (Oct 31).' },
                { year: 2012, type: 'human', note: 'Global births peak at 146M â€” the most humans ever born in a single year.' },
                { year: 2020, type: 'human', note: 'COVID-19 pandemic. Many countries see birth rate drops 9 months later.' },
                { year: 2023, type: 'human', note: 'World population reaches 8 billion. Birth rates continuing secular decline.' },
                { year: 2030, type: 'human', note: 'Projected: India surpasses China as most populous nation.' },
                { year: 2050, type: 'human', note: 'UN projects population plateau beginning. Some models predict peak and decline.' },

                // Chip/Computing milestones
                { year: 1971, type: 'chip', note: 'Intel 4004: First commercial microprocessor. 2,300 transistors, 740 kHz.' },
                { year: 1975, type: 'chip', note: 'Altair 8800 launches hobbyist computing. MITS sells 2,000 units.' },
                { year: 1981, type: 'chip', note: 'IBM PC launched. Intel 8088 @ 4.77 MHz. Personal computing era begins.' },
                { year: 1985, type: 'chip', note: 'Intel 386: First 32-bit x86 processor. 275,000 transistors.' },
                { year: 1993, type: 'chip', note: 'Intel Pentium: 3.1M transistors. "Intel Inside" marketing begins.' },
                { year: 1997, type: 'chip', note: 'IBM Deep Blue defeats Kasparov. First AI victory over world chess champion.' },
                { year: 1999, type: 'chip', note: 'NVIDIA GeForce 256: First GPU. "A new era of computing" begins.' },
                { year: 2007, type: 'chip', note: 'iPhone launches. NVIDIA CUDA released. Mobile + GPU computing revolution.' },
                { year: 2012, type: 'chip', note: 'AlexNet wins ImageNet using GPUs. Deep learning revolution begins.' },
                { year: 2016, type: 'chip', note: 'Google TPU announced. AlphaGo defeats Lee Sedol. AI-specific silicon emerges.' },
                { year: 2017, type: 'chip', note: '"Attention Is All You Need" published. Transformer architecture invented.' },
                { year: 2020, type: 'chip', note: 'NVIDIA A100: 54B transistors, 312 TFLOPS. GPT-3 released.' },
                { year: 2022, type: 'chip', note: 'ChatGPT launches (Nov 30). AI demand explosion begins.' },
                { year: 2023, type: 'chip', note: 'NVIDIA H100 ships at scale. Data center GPU shortage. $1T+ AI investment wave.' },
                { year: 2024, type: 'chip', note: 'NVIDIA Blackwell (B100): 208B transistors. AI chip production at unprecedented scale.' },
                { year: 2025, type: 'chip', note: 'Epoch AI estimates 6-7M AI GPUs deployed globally. ~4M H100-equivalents installed.' },

                // Crossover/Meta observations
                { year: 2040, type: 'meta', note: 'Projected crossover zone (moderate brain estimate). The Flippening approaches.' },
                { year: 2045, type: 'meta', note: 'Kurzweil\'s predicted Singularity year (from "The Singularity Is Near", 2005).' },

                // Future predictions (AI-2027.com & Situational Awareness)
                { year: 2026, type: 'prediction', note: 'AI-2027: R&D automation begins. 50% faster algorithmic progress via AI assistants. 10Â²â¸ FLOP training runs.' },
                { year: 2027, type: 'prediction', note: 'AI-2027: Superhuman coder (March), superhuman AI researcher (Sept), potential superintelligence (Dec). Situational Awareness: "AGI by 2027 is strikingly plausible."' },
                { year: 2028, type: 'prediction', note: 'Situational Awareness: Intelligence explosion â€” "hundreds of millions of AGIs could compress a decade of progress into â‰¤1 year."' },
                { year: 2029, type: 'prediction', note: 'Situational Awareness: Superintelligent systems "smarter than you or I" by end of decade. $100B+ compute clusters.' },
                { year: 2030, type: 'prediction', note: 'Situational Awareness: American electricity production grows "tens of percent" to support hundreds of millions of GPUs.' }
            ]
        };

        // ============================================
        // STATE
        // ============================================

        let state = {
            brainEstimate: 'moderate',
            birthScenario: 'stable',
            mooresLawRate: 0.35,  // 35% annual growth
            chart: null,
            // Calculus mode: 0 = cumulative (âˆ«), -1 = rate (d/dt), -2 = acceleration (dÂ²/dtÂ²)
            calculusLevel: 0
        };

        // Session tracking - how much has changed since page load
        const sessionStart = {
            timestamp: Date.now(),
            humanOps: 0,  // Will be set on init
            chipOps: 0    // Will be set on init
        };

        // ============================================
        // CALCULATIONS
        // ============================================

        function getBirthsForYear(year) {
            if (year <= 2025) {
                // Use historical data with interpolation
                const years = Object.keys(CONFIG.historicalBirths).map(Number).sort((a, b) => a - b);
                for (let i = 0; i < years.length - 1; i++) {
                    if (year >= years[i] && year <= years[i + 1]) {
                        const t = (year - years[i]) / (years[i + 1] - years[i]);
                        return CONFIG.historicalBirths[years[i]] * (1 - t) +
                               CONFIG.historicalBirths[years[i + 1]] * t;
                    }
                }
                return CONFIG.historicalBirths[years[years.length - 1]];
            } else {
                // Project future based on scenario
                const scenario = CONFIG.birthScenarios[state.birthScenario];
                const yearsFromBase = year - 2025;
                return scenario.base2025 * Math.pow(1 + scenario.annualChange, yearsFromBase) / 1e6;
            }
        }

        function getChipFLOPSForYear(year) {
            if (year <= 2025) {
                // Use historical data with interpolation
                const years = Object.keys(CONFIG.historicalChipFLOPS).map(Number).sort((a, b) => a - b);

                if (year < years[0]) return 0;

                for (let i = 0; i < years.length - 1; i++) {
                    if (year >= years[i] && year <= years[i + 1]) {
                        // Exponential interpolation
                        const t = (year - years[i]) / (years[i + 1] - years[i]);
                        const logStart = Math.log10(CONFIG.historicalChipFLOPS[years[i]]);
                        const logEnd = Math.log10(CONFIG.historicalChipFLOPS[years[i + 1]]);
                        return Math.pow(10, logStart + t * (logEnd - logStart));
                    }
                }
                return CONFIG.historicalChipFLOPS[years[years.length - 1]];
            } else {
                // Project future with Moore's Law rate
                const base = CONFIG.historicalChipFLOPS[2025];
                const yearsFromBase = year - 2025;
                return base * Math.pow(1 + state.mooresLawRate, yearsFromBase);
            }
        }

        function getCumulativeOps(year, type) {
            let cumulative = 0;
            const brainOps = CONFIG.brainEstimates[state.brainEstimate];

            for (let y = CONFIG.startYear; y <= year; y++) {
                if (type === 'human') {
                    // Births in millions Ã— brain ops per brain
                    const birthsMillions = getBirthsForYear(y);
                    cumulative += birthsMillions * 1e6 * brainOps;
                } else {
                    cumulative += getChipFLOPSForYear(y);
                }
            }
            return cumulative;
        }

        function findCrossoverYear() {
            // More efficient: compute incrementally and find crossover with interpolation
            let humanCumulative = 0;
            let chipCumulative = 0;
            let prevHuman = 0;
            let prevChip = 0;
            const brainOps = CONFIG.brainEstimates[state.brainEstimate];

            for (let year = CONFIG.startYear; year <= CONFIG.endYear; year++) {
                prevHuman = humanCumulative;
                prevChip = chipCumulative;

                const birthsMillions = getBirthsForYear(year);
                humanCumulative += birthsMillions * 1e6 * brainOps;
                chipCumulative += getChipFLOPSForYear(year);

                // Check if crossover happened this year
                if (chipCumulative >= humanCumulative && prevChip < prevHuman) {
                    // Linear interpolation to estimate sub-year crossover
                    // Find t where: prevChip + t*(chipCumulative-prevChip) = prevHuman + t*(humanCumulative-prevHuman)
                    const chipDelta = chipCumulative - prevChip;
                    const humanDelta = humanCumulative - prevHuman;
                    const gap = prevHuman - prevChip;
                    const closingRate = chipDelta - humanDelta;

                    if (closingRate > 0) {
                        const t = gap / closingRate;
                        return year - 1 + Math.max(0, Math.min(1, t));
                    }
                    return year;
                }

                // Also check if chip already exceeded at start of range
                if (year === CONFIG.startYear && chipCumulative >= humanCumulative) {
                    return year;
                }
            }
            return null;  // No crossover in range
        }

        function formatMIPS(value) {
            if (value === 0) return '0';

            const exponent = Math.floor(Math.log10(value));
            const mantissa = value / Math.pow(10, exponent);

            if (exponent < 6) {
                return value.toLocaleString();
            } else if (exponent < 9) {
                return (value / 1e6).toFixed(2) + ' million';
            } else if (exponent < 12) {
                return (value / 1e9).toFixed(2) + ' billion';
            } else if (exponent < 15) {
                return (value / 1e12).toFixed(2) + ' trillion';
            } else {
                return mantissa.toFixed(2) + ' Ã— 10^' + exponent;
            }
        }

        function formatScientific(value) {
            if (value === 0) return '0';
            const sign = value < 0 ? '-' : '';
            const absValue = Math.abs(value);
            const exponent = Math.floor(Math.log10(absValue));
            const mantissa = absValue / Math.pow(10, exponent);
            return sign + mantissa.toFixed(2) + ' Ã— 10^' + exponent;
        }

        // Get historical annotations for a given year (with proximity tolerance)
        function getAnnotationsForYear(year, tolerance = 1) {
            return CONFIG.annotations.filter(a =>
                Math.abs(a.year - year) <= tolerance
            );
        }

        // ============================================
        // CHART
        // ============================================

        function generateChartData() {
            const years = [];
            let humanData = [];
            let chipData = [];

            // Extend calculation beyond display range to avoid boundary artifacts
            // when differentiating (edge effects from finite differences)
            const bufferYears = Math.abs(state.calculusLevel) * 2;  // 2 extra years per derivative
            const calcEndYear = CONFIG.endYear + bufferYears;

            // First get cumulative data (with buffer)
            for (let year = CONFIG.startYear; year <= calcEndYear; year += 1) {
                years.push(year);
                humanData.push(getCumulativeOps(year, 'human'));
                chipData.push(getCumulativeOps(year, 'chip'));
            }

            // Apply calculus transformations based on level
            // Level 0: cumulative (default)
            // Level -1: first derivative (rate of change)
            // Level -2: second derivative (acceleration)
            if (state.calculusLevel < 0) {
                for (let d = 0; d > state.calculusLevel; d--) {
                    humanData = differentiate(humanData);
                    chipData = differentiate(chipData);
                }
            }

            // Trim to display range (remove buffer years)
            const displayLength = CONFIG.endYear - CONFIG.startYear + 1;
            return {
                years: years.slice(0, displayLength),
                humanData: humanData.slice(0, displayLength),
                chipData: chipData.slice(0, displayLength)
            };
        }

        // Numerical differentiation (central differences for interior points)
        function differentiate(data) {
            if (data.length < 2) return [0];

            const result = [];

            // First point: forward difference
            result.push(data[1] - data[0]);

            // Interior points: central difference (more accurate, properly centered)
            for (let i = 1; i < data.length - 1; i++) {
                // Central difference: (f(x+1) - f(x-1)) / 2
                const derivative = (data[i + 1] - data[i - 1]) / 2;
                result.push(derivative);
            }

            // Last point: backward difference
            result.push(data[data.length - 1] - data[data.length - 2]);

            return result;
        }

        // Get label for current calculus level
        function getCalculusLabel() {
            switch (state.calculusLevel) {
                case 0: return 'âˆ« Cumulative';
                case -1: return 'd/dt Rate';
                case -2: return 'dÂ²/dtÂ² Acceleration';
                default: return 'Level ' + state.calculusLevel;
            }
        }

        // Get Y-axis label for current calculus level
        function getYAxisLabel() {
            switch (state.calculusLevel) {
                case 0: return 'Cumulative ops (log scale)';
                case -1: return 'ops/year (log scale)';
                case -2: return 'ops/yearÂ² (linear) â€” negative = declining rates';
                default: return 'ops (log scale)';
            }
        }

        // Get dataset labels for current calculus level
        function getHumanDataLabel() {
            switch (state.calculusLevel) {
                case 0: return 'Cumulative Human Brain ops/s';
                case -1: return 'Human Brain ops/year (rate)';
                case -2: return 'Human Brain acceleration';
                default: return 'Human Brain ops';
            }
        }

        function getChipDataLabel() {
            switch (state.calculusLevel) {
                case 0: return 'Cumulative Chip FLOPS';
                case -1: return 'Chip FLOPS/year (rate)';
                case -2: return 'Chip FLOPS acceleration';
                default: return 'Chip FLOPS';
            }
        }

        // Get Y-axis configuration based on calculus level
        // Acceleration view uses linear scale to show negative values (deceleration)
        function getYAxisConfig() {
            const baseConfig = {
                grid: {
                    color: 'rgba(255, 255, 255, 0.05)'
                },
                ticks: {
                    color: '#a0a0a0'
                },
                title: {
                    display: true,
                    text: getYAxisLabel(),
                    color: '#a0a0a0'
                }
            };

            if (state.calculusLevel === -2) {
                // Acceleration view: use linear scale to properly show negative values
                return {
                    ...baseConfig,
                    type: 'linear',
                    ticks: {
                        ...baseConfig.ticks,
                        callback: function(value) {
                            return formatScientific(value);
                        },
                        maxTicksLimit: 8
                    }
                };
            } else {
                // Cumulative and rate views: use log scale
                return {
                    ...baseConfig,
                    type: 'logarithmic',
                    ticks: {
                        ...baseConfig.ticks,
                        callback: function(value) {
                            const exp = Math.log10(value);
                            if (Number.isInteger(exp) && exp % 5 === 0) {
                                return '10^' + exp;
                            }
                            return '';
                        }
                    }
                };
            }
        }

        // Custom tooltip positioner that avoids covering the data point
        Chart.Tooltip.positioners.avoidPoint = function(elements, eventPosition) {
            if (!elements.length) {
                return false;
            }

            const chart = this.chart;
            const chartArea = chart.chartArea;
            const tooltipEl = chart.tooltip;

            // Find the bounding box of ALL data points being shown
            let minY = Infinity, maxY = -Infinity;
            let pointX = 0;
            for (const el of elements) {
                const pt = el.element;
                pointX = pt.x;
                minY = Math.min(minY, pt.y);
                maxY = Math.max(maxY, pt.y);
            }

            // Get actual tooltip size
            const tooltipWidth = tooltipEl.width || 350;
            const tooltipHeight = tooltipEl.height || 200;

            const margin = 20;

            // Calculate available space
            const spaceBelow = chartArea.bottom - maxY;
            const spaceAbove = minY - chartArea.top;

            let x, y;

            // Horizontal: position at the data point X (caret will point here)
            // Chart.js will center the tooltip on this X position
            x = pointX;
            // Clamp to keep tooltip within chart area (accounting for half-width on each side)
            x = Math.max(chartArea.left + tooltipWidth / 2 + 5, Math.min(x, chartArea.right - tooltipWidth / 2 - 5));

            // Vertical: position below lowest point if possible, else above highest
            if (spaceBelow >= tooltipHeight + margin) {
                y = maxY + margin;
            } else if (spaceAbove >= tooltipHeight + margin) {
                y = minY - tooltipHeight - margin;
            } else {
                // Tight space - push to bottom of chart area
                y = chartArea.bottom - tooltipHeight - 10;
            }

            // Clamp y to chart area
            y = Math.max(chartArea.top + 5, Math.min(y, chartArea.bottom - tooltipHeight - 5));

            return { x, y };
        };

        function createChart() {
            const ctx = document.getElementById('mips-chart').getContext('2d');
            const data = generateChartData();
            const crossoverYear = findCrossoverYear();
            const currentYear = new Date().getFullYear();
            // For category scales, annotations need the index, not the value
            const currentYearIndex = currentYear - CONFIG.startYear;
            const crossoverYearIndex = crossoverYear ? Math.round(crossoverYear) - CONFIG.startYear : null;
            console.log('Chart annotation debug:', { crossoverYear, currentYear, currentYearIndex, crossoverYearIndex, hasAnnotationPlugin: !!annotationPlugin });

            // Find crossover index for annotation (legacy - used elsewhere)
            const crossoverIndex = crossoverYear ? Math.floor(crossoverYear - CONFIG.startYear) : null;

            state.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.years,
                    datasets: [
                        {
                            label: getHumanDataLabel(),
                            data: data.humanData,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: getChipDataLabel(),
                            data: data.chipData,
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#a0a0a0',
                                maxTicksLimit: 10
                            }
                        },
                        y: getYAxisConfig()
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0',
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 46, 0.98)',
                            titleColor: '#e0e0e0',
                            bodyColor: '#a0a0a0',
                            borderColor: '#2a2a3e',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            position: 'avoidPoint',
                            yAlign: 'top',
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatScientific(context.raw);
                                },
                                afterBody: function(context) {
                                    if (!context.length) return [];
                                    const year = context[0].label;
                                    const annotations = getAnnotationsForYear(parseInt(year), 1);
                                    if (annotations.length === 0) return [];

                                    const lines = ['', 'â€” N.B. â€”'];
                                    annotations.forEach(a => {
                                        // Add emoji based on type
                                        const icon = a.type === 'human' ? 'ðŸ§ ' :
                                                    a.type === 'chip' ? 'ðŸ’¾' :
                                                    a.type === 'prediction' ? 'ðŸ”®' : 'âš¡';
                                        lines.push(icon + ' ' + a.note);
                                    });
                                    return lines;
                                }
                            },
                            footerColor: '#ffd93d',
                            footerFont: { size: 11, style: 'italic' }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy',
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                                    borderColor: 'rgba(78, 205, 196, 0.5)',
                                    borderWidth: 1
                                },
                                mode: 'xy',
                            }
                        },
                        annotation: crossoverYear ? {
                            annotations: {
                                crossoverLine: {
                                    type: 'line',
                                    xMin: crossoverYearIndex,
                                    xMax: crossoverYearIndex,
                                    borderColor: '#ffd93d',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        display: true,
                                        content: 'Crossover: ' + Math.round(crossoverYear),
                                        position: 'start',
                                        backgroundColor: 'rgba(255, 217, 61, 0.8)',
                                        color: '#0a0a0f',
                                        font: { weight: 'bold' }
                                    }
                                },
                                nowLine: {
                                    type: 'line',
                                    xMin: currentYearIndex,
                                    xMax: currentYearIndex,
                                    borderColor: '#4ecdc4',
                                    borderWidth: 3,
                                    borderDash: [6, 4],
                                    label: {
                                        display: true,
                                        content: 'TODAY',
                                        position: 'start',
                                        backgroundColor: '#4ecdc4',
                                        color: '#0a0a0f',
                                        font: { size: 12, weight: 'bold' },
                                        padding: 6
                                    }
                                }
                            }
                        } : {
                            annotations: {
                                nowLine: {
                                    type: 'line',
                                    xMin: currentYearIndex,
                                    xMax: currentYearIndex,
                                    borderColor: '#4ecdc4',
                                    borderWidth: 3,
                                    borderDash: [6, 4],
                                    label: {
                                        display: true,
                                        content: 'TODAY',
                                        position: 'start',
                                        backgroundColor: '#4ecdc4',
                                        color: '#0a0a0f',
                                        font: { size: 12, weight: 'bold' },
                                        padding: 6
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (!state.chart) return;

            // Destroy and recreate to update annotations
            state.chart.destroy();
            createChart();
        }

        // ============================================
        // COUNTERS
        // ============================================

        // Real-time counter state
        let counterState = {
            humanOps: 0,
            chipOps: 0,
            humanRate: 0,
            chipRate: 0,
            lastUpdate: Date.now(),
            initialized: false
        };

        function initializeCounters() {
            const now = new Date();
            const currentYear = now.getFullYear() + (now.getMonth() / 12) + (now.getDate() / 365);

            counterState.humanOps = getCumulativeOps(currentYear, 'human');
            counterState.chipOps = getCumulativeOps(currentYear, 'chip');

            // Calculate rates (ops per millisecond for smooth animation)
            const brainOps = CONFIG.brainEstimates[state.brainEstimate];
            const birthsPerSecond = getBirthsForYear(Math.floor(currentYear)) * 1e6 / (365.25 * 24 * 3600);
            counterState.humanRate = birthsPerSecond * brainOps / 1000;  // per ms

            const chipFLOPSThisYear = getChipFLOPSForYear(Math.floor(currentYear));
            counterState.chipRate = chipFLOPSThisYear / (365.25 * 24 * 3600 * 1000);  // per ms

            counterState.lastUpdate = Date.now();
            counterState.initialized = true;

            // Initialize session start values (only once, on first page load)
            if (sessionStart.humanOps === 0) {
                sessionStart.humanOps = counterState.humanOps;
                sessionStart.chipOps = counterState.chipOps;
            }
        }

        function updateCounters() {
            if (!counterState.initialized) {
                initializeCounters();
            }

            const now = Date.now();
            const elapsed = now - counterState.lastUpdate;
            counterState.lastUpdate = now;

            // Increment based on elapsed time
            counterState.humanOps += counterState.humanRate * elapsed;
            counterState.chipOps += counterState.chipRate * elapsed;

            // Update display
            document.getElementById('human-mips').textContent = formatScientific(counterState.humanOps) + ' ops';
            document.getElementById('chip-mips').textContent = formatScientific(counterState.chipOps) + ' ops';

            // Calculate human-readable rates
            const brainOps = CONFIG.brainEstimates[state.brainEstimate];
            const currentYear = new Date().getFullYear();
            const birthsPerSecond = getBirthsForYear(currentYear) * 1e6 / (365.25 * 24 * 3600);

            document.getElementById('human-rate').textContent =
                '+' + formatScientific(counterState.humanRate * 1000) + ' ops/sec (' + birthsPerSecond.toFixed(1) + ' births/sec)';
            document.getElementById('chip-rate').textContent =
                '+' + formatScientific(counterState.chipRate * 1000) + ' ops/sec (continuous production)';

            // Update session stats
            updateSessionStats();
        }

        function updateSessionStats() {
            const brainOps = CONFIG.brainEstimates[state.brainEstimate];
            const elapsedMs = Date.now() - sessionStart.timestamp;
            const elapsedSec = elapsedMs / 1000;

            // Calculate brains born since session start (using current birth rate)
            const currentYear = new Date().getFullYear();
            const birthsPerSecond = getBirthsForYear(currentYear) * 1e6 / (365.25 * 24 * 3600);
            const brainsBorn = birthsPerSecond * elapsedSec;

            // Calculate FLOPS manufactured since session start
            const chipFLOPSThisYear = getChipFLOPSForYear(currentYear);
            const flopsPerSecond = chipFLOPSThisYear / (365.25 * 24 * 3600);
            const flopsMade = flopsPerSecond * elapsedSec;

            // Format for display
            document.getElementById('session-brains').textContent = formatSessionCount(brainsBorn);
            document.getElementById('session-flops').textContent = formatScientific(flopsMade);
        }

        function formatSessionCount(value) {
            if (value < 1) return value.toFixed(2);
            if (value < 1000) return Math.floor(value).toLocaleString();
            if (value < 1e6) return (value / 1000).toFixed(1) + 'K';
            return (value / 1e6).toFixed(2) + 'M';
        }

        function resetCounters() {
            counterState.initialized = false;
            initializeCounters();
        }

        function updateCrossover() {
            const crossoverYear = findCrossoverYear();
            const crossoverDateEl = document.getElementById('crossover-date');
            const crossoverStatusEl = document.getElementById('crossover-status');

            if (crossoverYear === null) {
                crossoverDateEl.textContent = 'Beyond 2070';
                crossoverStatusEl.textContent = 'With current assumptions, crossover is not reached by 2070';
            } else if (crossoverYear <= new Date().getFullYear()) {
                crossoverDateEl.textContent = Math.round(crossoverYear);
                crossoverStatusEl.textContent = 'CROSSOVER ALREADY OCCURRED - Chip FLOPS exceeded human brain ops/s';
            } else {
                const yearsUntil = crossoverYear - new Date().getFullYear();
                crossoverDateEl.textContent = Math.round(crossoverYear);
                crossoverStatusEl.textContent =
                    `~${Math.round(yearsUntil)} years from now (with current growth assumptions)`;
            }
        }

        // ============================================
        // CONTROLS
        // ============================================

        function setupControls() {
            // Brain estimate buttons
            document.querySelectorAll('[data-brain]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-brain]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.brainEstimate = btn.dataset.brain;
                    updateAll();
                });
            });

            // Birth scenario buttons
            document.querySelectorAll('[data-birth]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-birth]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.birthScenario = btn.dataset.birth;
                    updateAll();
                });
            });

            // Moore's Law slider
            const slider = document.getElementById('moore-slider');
            const sliderValue = document.getElementById('moore-value');
            slider.addEventListener('input', () => {
                state.mooresLawRate = slider.value / 100;
                sliderValue.textContent = slider.value + '%';
                updateAll();
            });

            // Reset button for Moore's Law slider
            const resetBtn = document.getElementById('moore-reset');
            resetBtn.addEventListener('click', () => {
                const defaultValue = 35;
                state.mooresLawRate = defaultValue / 100;
                slider.value = defaultValue;
                sliderValue.textContent = defaultValue + '%';
                updateAll();
            });

            // Calculus controls - integrate/differentiate
            setupCalculusControls();
        }

        function setupCalculusControls() {
            const calcUp = document.getElementById('calc-up');
            const calcDown = document.getElementById('calc-down');
            const calcLevel = document.getElementById('calc-level');

            function updateCalculusUI() {
                calcLevel.textContent = getCalculusLabel();
                // Disable up button at level 0 (cumulative)
                calcUp.disabled = state.calculusLevel >= 0;
                // Disable down button at level -2 (acceleration)
                calcDown.disabled = state.calculusLevel <= -2;
            }

            // Integrate (up) - go towards cumulative
            calcUp.addEventListener('click', () => {
                if (state.calculusLevel < 0) {
                    state.calculusLevel++;
                    updateCalculusUI();
                    updateChart();
                    trackEvent('interaction', 'calculus_integrate', { level: state.calculusLevel });
                }
            });

            // Differentiate (down) - go towards acceleration
            calcDown.addEventListener('click', () => {
                if (state.calculusLevel > -2) {
                    state.calculusLevel--;
                    updateCalculusUI();
                    updateChart();
                    trackEvent('interaction', 'calculus_differentiate', { level: state.calculusLevel });
                }
            });

            // Reset zoom button
            document.getElementById('reset-zoom').addEventListener('click', () => {
                if (state.chart) {
                    state.chart.resetZoom();
                    trackEvent('interaction', 'reset_zoom');
                }
            });

            updateCalculusUI();
        }

        function updateAll() {
            resetCounters();  // Reset counters when assumptions change
            updateChart();
            updateCounters();
            updateCrossover();
            updateURL();
        }

        // ============================================
        // URL SHARING
        // ============================================

        function updateURL() {
            const existing = new URLSearchParams(window.location.search);
            const params = new URLSearchParams();
            params.set('brain', state.brainEstimate);
            params.set('birth', state.birthScenario);
            params.set('moore', Math.round(state.mooresLawRate * 100));
            // Preserve privacy opt-out flag if present
            if (existing.get('noanalytics') === '1') {
                params.set('noanalytics', '1');
            }

            const newURL = window.location.pathname + '?' + params.toString();
            history.replaceState(null, '', newURL);
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);

            if (params.has('brain') && CONFIG.brainEstimates[params.get('brain')]) {
                state.brainEstimate = params.get('brain');
                document.querySelectorAll('[data-brain]').forEach(b => {
                    b.classList.toggle('active', b.dataset.brain === state.brainEstimate);
                });
            }

            if (params.has('birth') && CONFIG.birthScenarios[params.get('birth')]) {
                state.birthScenario = params.get('birth');
                document.querySelectorAll('[data-birth]').forEach(b => {
                    b.classList.toggle('active', b.dataset.birth === state.birthScenario);
                });
            }

            if (params.has('moore')) {
                const moore = parseInt(params.get('moore'));
                if (moore >= 20 && moore <= 60) {
                    state.mooresLawRate = moore / 100;
                    document.getElementById('moore-slider').value = moore;
                    document.getElementById('moore-value').textContent = moore + '%';
                }
            }
        }

        // ============================================
        // SUGGESTION FORM HANDLING
        // ============================================

        const ALLOWED_DOMAINS = [
            'gov', 'edu', 'org', 'int',  // TLDs
            'arxiv.org', 'nature.com', 'science.org', 'sciencedirect.com',
            'springer.com', 'wiley.com', 'pnas.org', 'cell.com',
            'sec.gov', 'census.gov', 'bls.gov', 'un.org', 'worldbank.org',
            'imf.org', 'oecd.org', 'who.int', 'wsts.org',
            'nvidia.com', 'investor.nvidia.com', 'intel.com', 'amd.com',
            'tsmc.com', 'semiconductors.org', 'semi.org',
            'epoch.ai', 'aiimpacts.org', 'ourworldindata.org',
            'statista.com', 'macrotrends.net', 'tradingeconomics.com'
        ];

        function isAllowedDomain(url) {
            try {
                const hostname = new URL(url).hostname.toLowerCase();
                return ALLOWED_DOMAINS.some(domain => {
                    if (domain.includes('.')) {
                        // Full domain match
                        return hostname === domain || hostname.endsWith('.' + domain);
                    } else {
                        // TLD match
                        return hostname.endsWith('.' + domain);
                    }
                });
            } catch {
                return false;
            }
        }

        function sanitizeInput(str, maxLength = 200) {
            if (!str) return '';
            return str
                .replace(/<[^>]*>/g, '')  // Strip HTML tags
                .replace(/[<>"'`]/g, '')   // Remove dangerous chars
                .trim()
                .slice(0, maxLength);
        }

        function setupSuggestionForm() {
            const form = document.getElementById('suggest-form');
            const statusEl = document.getElementById('form-status');
            const submitBtn = document.getElementById('submit-btn');

            // API endpoint - replace with your Lambda URL after deployment
            const API_ENDPOINT = 'https://tnu93m4j91.execute-api.ca-central-1.amazonaws.com/suggest';

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                statusEl.className = 'form-status';
                statusEl.textContent = '';

                const formData = new FormData(form);
                const sourceUrl = formData.get('sourceUrl');

                // Client-side validation
                if (!sourceUrl.startsWith('https://')) {
                    statusEl.className = 'form-status error';
                    statusEl.textContent = 'URL must use HTTPS';
                    return;
                }

                if (!isAllowedDomain(sourceUrl)) {
                    statusEl.className = 'form-status error';
                    statusEl.textContent = 'Please use a trusted source (.gov, .edu, .org, academic publishers, or official company sites)';
                    return;
                }

                // Prepare sanitized payload
                const payload = {
                    dataType: sanitizeInput(formData.get('dataType'), 20),
                    year: parseInt(formData.get('year')) || null,
                    sourceUrl: sourceUrl,  // Already validated
                    value: sanitizeInput(formData.get('value'), 200),
                    sourceName: sanitizeInput(formData.get('sourceName'), 100),
                    timestamp: new Date().toISOString()
                };

                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        statusEl.className = 'form-status success';
                        statusEl.textContent = `Suggestion submitted! Issue #${result.issueNumber} created for review.`;
                        form.reset();
                    } else {
                        throw new Error('Submission failed');
                    }
                } catch (err) {
                    statusEl.className = 'form-status error';
                    statusEl.textContent = 'Submission failed. Please try again or open an issue directly on GitHub.';
                    console.error('Suggestion submission error:', err);
                }

                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Suggestion';
            });
        }

        // ============================================
        // LIVE DATA APIs (optional enhancement)
        // ============================================

        // Attempt to fetch live data from APIs
        // Falls back gracefully to cached data if unavailable
        async function fetchLiveData() {
            const status = { population: 'cached', chips: 'cached' };

            // Try fetching world population data from API Ninjas (free tier)
            // This is optional - we fall back to cached data if it fails
            try {
                // Population.io API for world population
                const response = await fetch('https://d6wn6bmjj722w.population.io/1.0/population/World/today-and-tomorrow/');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.total_population) {
                        // Could update CONFIG with live data here
                        status.population = 'live';
                        console.log('Live population data available:', data);
                    }
                }
            } catch (e) {
                console.log('Using cached population data (API unavailable)');
            }

            // Epoch AI data is available as CSV download, not live API
            // NVIDIA SEC filings require manual parsing
            // WSTS requires subscription
            // So chip data remains cached but well-sourced

            return status;
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            loadFromURL();
            createChart();
            setupControls();
            setupDownloadButtons();
            setupPrivacyControls();
            setupSuggestionForm();
            updateCounters();
            updateCrossover();

            // Try to fetch live data (non-blocking)
            fetchLiveData().then(status => {
                console.log('Data source status:', status);
            });

            // Update counters periodically
            // Update counters every 50ms for smooth animation
            setInterval(updateCounters, 50);
        });

        // ============================================
        // ANALYTICS TRACKING
        // ============================================

        const ANALYTICS_ENDPOINT = 'https://tnu93m4j91.execute-api.ca-central-1.amazonaws.com/t/e';

        function analyticsOptedOut() {
            try {
                const params = new URLSearchParams(window.location.search);
                if (params.get('noanalytics') === '1') return true;
                return localStorage.getItem('foomist_analytics_optout') === '1';
            } catch {
                return false;
            }
        }

        // Generate or retrieve visitor ID (persistent across sessions)
        function getVisitorId() {
            let visitorId = localStorage.getItem('foomist_visitor_id');
            if (!visitorId) {
                visitorId = crypto.randomUUID ? crypto.randomUUID() :
                    'v_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('foomist_visitor_id', visitorId);
            }
            return visitorId;
        }

        // Generate or retrieve session ID (cleared on browser close)
        function getSessionId() {
            let sessionId = sessionStorage.getItem('foomist_session_id');
            if (!sessionId) {
                sessionId = crypto.randomUUID ? crypto.randomUUID() :
                    's_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('foomist_session_id', sessionId);
                sessionStorage.setItem('foomist_session_start', Date.now().toString());
            }
            return sessionId;
        }

        // Get session duration in seconds
        function getSessionDuration() {
            const start = sessionStorage.getItem('foomist_session_start');
            return start ? Math.round((Date.now() - parseInt(start, 10)) / 1000) : 0;
        }

        // Get client info for analytics
        function getClientInfo() {
            return {
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                screen: `${window.screen.width}x${window.screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform,
                cookiesEnabled: navigator.cookieEnabled
            };
        }

        // Track an event
        function trackEvent(eventType, eventName, metadata = {}) {
            if (analyticsOptedOut()) return;
            try {
                const data = {
                    visitorId: getVisitorId(),
                    sessionId: getSessionId(),
                    sessionDuration: getSessionDuration(),
                    eventType: eventType,
                    eventName: eventName,
                    page: window.location.pathname,
                    referrer: document.referrer || '',
                    userAgent: navigator.userAgent,
                    clientInfo: getClientInfo(),
                    metadata: metadata,
                    // Current app state for context
                    appState: {
                        brainEstimate: state.brainEstimate,
                        birthScenario: state.birthScenario,
                        mooresLawRate: Math.round(state.mooresLawRate * 100) + '%',
                        calculusLevel: state.calculusLevel
                    }
                };

                // Use fetch with keepalive for reliable analytics
                const payload = JSON.stringify(data);
                console.log('[Analytics] Sending:', eventType, eventName);
                fetch(ANALYTICS_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: payload,
                    keepalive: true,
                    mode: 'cors'
                }).then(r => {
                    console.log('[Analytics] Response:', r.status);
                }).catch(e => {
                    console.error('[Analytics] Error:', e);
                });
            } catch (e) {
                console.error('[Analytics] Exception:', e);
            }
        }

        // Track page view on load
        window.addEventListener('load', () => {
            trackEvent('page_view', 'page_load', {
                url: window.location.href,
                title: document.title
            });
        });

        // ============================================
        // DOWNLOAD DATA
        // ============================================

        function getDownloadMetadata() {
            return {
                exportedAt: new Date().toISOString(),
                site: window.location.origin,
                state: {
                    brainEstimate: state.brainEstimate,
                    birthScenario: state.birthScenario,
                    mooresLawRate: state.mooresLawRate,
                    calculusLevel: state.calculusLevel,
                    calculusLabel: getCalculusLabel()
                },
                range: {
                    startYear: CONFIG.startYear,
                    endYear: CONFIG.endYear
                }
            };
        }

        function getDownloadRows() {
            const data = generateChartData();
            return data.years.map((year, idx) => ({
                year,
                human: data.humanData[idx],
                chip: data.chipData[idx]
            }));
        }

        function rowsToCSV(meta, rows) {
            const header = [
                '# foom.ist export',
                `# exportedAt=${meta.exportedAt}`,
                `# brainEstimate=${meta.state.brainEstimate}`,
                `# birthScenario=${meta.state.birthScenario}`,
                `# mooresLawRate=${meta.state.mooresLawRate}`,
                `# calculusLevel=${meta.state.calculusLevel}`,
                `# calculusLabel=${meta.state.calculusLabel}`,
                'year,human,chip'
            ].join('\n');
            const body = rows.map(r => `${r.year},${r.human},${r.chip}`).join('\n');
            return header + '\n' + body + '\n';
        }

        function triggerDownload(filename, contents, mimeType) {
            const blob = new Blob([contents], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 0);
        }

        function setupDownloadButtons() {
            const csvBtn = document.getElementById('download-csv');
            const jsonBtn = document.getElementById('download-json');
            if (!csvBtn || !jsonBtn) return;

            csvBtn.addEventListener('click', () => {
                const meta = getDownloadMetadata();
                const rows = getDownloadRows();
                const csv = rowsToCSV(meta, rows);
                const fname = `foomist_chart_${meta.state.brainEstimate}_${meta.state.birthScenario}_${Math.round(meta.state.mooresLawRate * 100)}pct_level${meta.state.calculusLevel}.csv`;
                triggerDownload(fname, csv, 'text/csv;charset=utf-8');
                trackEvent('interaction', 'download_csv', { filename: fname });
            });

            jsonBtn.addEventListener('click', () => {
                const meta = getDownloadMetadata();
                const rows = getDownloadRows();
                const payload = JSON.stringify({ meta, rows }, null, 2);
                const fname = `foomist_chart_${meta.state.brainEstimate}_${meta.state.birthScenario}_${Math.round(meta.state.mooresLawRate * 100)}pct_level${meta.state.calculusLevel}.json`;
                triggerDownload(fname, payload, 'application/json;charset=utf-8');
                trackEvent('interaction', 'download_json', { filename: fname });
            });
        }

        // ============================================
        // PRIVACY CONTROLS
        // ============================================

        function setupPrivacyControls() {
            const checkbox = document.getElementById('analytics-optout');
            if (!checkbox) return;

            checkbox.checked = analyticsOptedOut();

            checkbox.addEventListener('change', () => {
                const optingOut = checkbox.checked;
                try {
                    if (optingOut) {
                        // Record the intent before disabling.
                        trackEvent('interaction', 'analytics_optout', { enabled: false });
                        localStorage.setItem('foomist_analytics_optout', '1');
                    } else {
                        localStorage.setItem('foomist_analytics_optout', '0');
                        trackEvent('interaction', 'analytics_optout', { enabled: true });
                    }
                } catch (e) {
                    console.error('Failed to persist analytics opt-out:', e);
                }
            });
        }

        // Track brain estimate changes
        document.querySelectorAll('[data-brain]').forEach(btn => {
            btn.addEventListener('click', () => {
                trackEvent('interaction', 'brain_estimate_change', {
                    value: btn.dataset.brain
                });
            });
        });

        // Track birth scenario changes
        document.querySelectorAll('[data-birth]').forEach(btn => {
            btn.addEventListener('click', () => {
                trackEvent('interaction', 'birth_scenario_change', {
                    value: btn.dataset.birth
                });
            });
        });

        // Track Moore's Law slider changes (debounced)
        let mooreSliderTimeout = null;
        document.getElementById('moore-slider').addEventListener('change', (e) => {
            clearTimeout(mooreSliderTimeout);
            mooreSliderTimeout = setTimeout(() => {
                trackEvent('interaction', 'moore_slider_change', {
                    value: e.target.value + '%'
                });
            }, 500);
        });

        // Track reset button
        document.getElementById('moore-reset').addEventListener('click', () => {
            trackEvent('interaction', 'moore_reset_click');
        });

        // Track CTA button click
        document.querySelector('.cta-button').addEventListener('click', () => {
            trackEvent('interaction', 'cta_button_click');
        });

        // Copy link function
        function copyLink() {
            navigator.clipboard.writeText('https://foom.ist').then(() => {
                const copyText = document.getElementById('copy-text');
                copyText.textContent = 'Copied!';
                setTimeout(() => { copyText.textContent = 'Copy Link'; }, 2000);
                trackEvent('interaction', 'share_copy_link');
            });
        }
        window.copyLink = copyLink;

        // Track share button clicks
        document.querySelectorAll('.share-btn').forEach(btn => {
            if (!btn.classList.contains('copy')) {
                btn.addEventListener('click', () => {
                    const platform = btn.classList.contains('twitter') ? 'twitter' :
                                    btn.classList.contains('facebook') ? 'facebook' :
                                    btn.classList.contains('linkedin') ? 'linkedin' : 'unknown';
                    trackEvent('interaction', 'share_click', { platform });
                });
            }
        });

        // Track suggestion form submission
        document.getElementById('suggest-form').addEventListener('submit', () => {
            trackEvent('form', 'suggestion_submitted', {
                dataType: document.getElementById('data-type').value
            });
        });

        // Track scroll depth
        let maxScrollDepth = 0;
        window.addEventListener('scroll', () => {
            const scrollPercent = Math.round(
                (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100
            );
            if (scrollPercent > maxScrollDepth && scrollPercent % 25 === 0) {
                maxScrollDepth = scrollPercent;
                trackEvent('interaction', 'scroll_depth', {
                    depth: scrollPercent + '%'
                });
            }
        });

        // Track time on page (on unload)
        const pageLoadTime = Date.now();
        window.addEventListener('beforeunload', () => {
            const timeOnPage = Math.round((Date.now() - pageLoadTime) / 1000);
            trackEvent('session', 'page_exit', {
                timeOnPageSeconds: timeOnPage,
                maxScrollDepth: maxScrollDepth + '%',
                sessionDuration: getSessionDuration()
            });
        });

        // Track all external link clicks
        document.querySelectorAll('a[href^="http"]').forEach(link => {
            link.addEventListener('click', (e) => {
                const url = link.href;
                const text = link.textContent.trim().substring(0, 50);
                trackEvent('link_click', 'external_link', {
                    url: url,
                    text: text,
                    section: link.closest('.source-section')?.querySelector('.source-title')?.textContent || 'unknown'
                });
            });
        });

        // Track definitions panel toggle
        const definitionsPanel = document.querySelector('.definitions-panel');
        if (definitionsPanel) {
            definitionsPanel.addEventListener('toggle', (e) => {
                trackEvent('interaction', 'definitions_panel_toggle', {
                    open: definitionsPanel.open
                });
            });
        }

        // Track chart legend clicks (dataset visibility toggle)
        // This is handled via Chart.js plugin
        const originalLegendClick = Chart.defaults.plugins.legend.onClick;
        Chart.defaults.plugins.legend.onClick = function(e, legendItem, legend) {
            const datasetLabel = legendItem.text;
            const isHidden = legend.chart.isDatasetVisible(legendItem.datasetIndex);
            trackEvent('chart', 'legend_toggle', {
                dataset: datasetLabel,
                action: isHidden ? 'hide' : 'show'
            });
            // Call original handler
            if (originalLegendClick) {
                originalLegendClick.call(this, e, legendItem, legend);
            }
        };

        // Track chart zoom events (debounced)
        let zoomTimeout;
        function trackZoomEvent(chart, type) {
            clearTimeout(zoomTimeout);
            zoomTimeout = setTimeout(() => {
                const xScale = chart.scales.x;
                const yScale = chart.scales.y;
                trackEvent('chart', 'zoom_' + type, {
                    xMin: Math.round(xScale.min),
                    xMax: Math.round(xScale.max),
                    yMin: yScale.min?.toExponential(2),
                    yMax: yScale.max?.toExponential(2)
                });
            }, 500);
        }

        // Hook into chart zoom plugin events
        const originalZoomComplete = Chart.defaults.plugins.zoom?.zoom?.onZoomComplete;
        if (Chart.defaults.plugins.zoom) {
            Chart.defaults.plugins.zoom.zoom.onZoomComplete = function({chart}) {
                trackZoomEvent(chart, 'zoom');
                if (originalZoomComplete) originalZoomComplete({chart});
            };
            Chart.defaults.plugins.zoom.pan.onPanComplete = function({chart}) {
                trackZoomEvent(chart, 'pan');
            };
        }

        // Track annotation/tooltip views for significant years
        let lastAnnotationYear = null;
        const annotationYears = new Set(CONFIG.annotations.map(a => a.year));
        document.getElementById('mips-chart')?.addEventListener('mousemove', (e) => {
            if (!state.chart) return;
            const points = state.chart.getElementsAtEventForMode(e, 'nearest', { intersect: false }, true);
            if (points.length > 0) {
                const year = parseInt(state.chart.data.labels[points[0].index]);
                // Check if near an annotation year (Â±1)
                for (const annoYear of annotationYears) {
                    if (Math.abs(year - annoYear) <= 1 && lastAnnotationYear !== annoYear) {
                        lastAnnotationYear = annoYear;
                        const annotations = CONFIG.annotations.filter(a => a.year === annoYear);
                        trackEvent('chart', 'annotation_viewed', {
                            year: annoYear,
                            annotations: annotations.map(a => a.type + ': ' + a.note.substring(0, 50)).join('; ')
                        });
                        break;
                    }
                }
            }
        });
    </script>
</body>
</html>
